# Что такое XSS
Межсайтовые сценарии (также известные как XSS) - это уязвимость веб-безопасности, которая позволяет злоумышленнику нарушить взаимодействие пользователей с уязвимым приложением. Это позволяет злоумышленнику обойти *Same origin policy*, которая предназначена для отделения разных веб-сайтов друг от друга. Уязвимости межсайтового скриптинга обычно позволяют злоумышленнику маскироваться под пользователя-жертву, выполнять любые действия, которые может выполнить пользователь, и получать доступ к любым данным пользователя. Если пользователь-жертва имеет привилегированный доступ в приложении, злоумышленник может получить полный контроль над всеми функциями и данными приложения.
# Как работает XSS
Межсайтовые сценарии работают путем манипулирования уязвимым веб-сайтом, чтобы он возвращал пользователям вредоносный JavaScript. Когда вредоносный код выполняется в браузере жертвы, злоумышленник может полностью скомпрометировать их взаимодействие с приложением.
![](https://portswigger.net/web-security/images/cross-site-scripting.svg)
# XSS proof of concept
Вы можете подтвердить большинство видов уязвимости XSS, введя полезную нагрузку, которая заставляет ваш собственный браузер выполнять произвольный JavaScript. Уже давно стало обычной практикой использовать функцию *alert()* для этой цели, потому что она короткая, безвредная и ее довольно трудно пропустить при успешном вызове. Фактически, вы решаете большинство XSS-лабораторий *portswigger*, вызывая alert() в браузере имитируемой жертвы.

К сожалению, есть небольшая заминка, если вы используете Chrome. Начиная с версии 92 и далее (20 июля 2021 года), iframes из разных источников не могут вызывать alert(). Поскольку они используются для построения некоторых более продвинутых атак XSS, иногда вам потребуется использовать альтернативную полезную нагрузку PoC. В этом случае мы рекомендуем использовать функцию print(). 
# Какие типы XSS-атак существуют
Существует три основных типа XSS-атак. Это:

* Reflected (отраженный) XSS, когда вредоносный скрипт возвращается из текущего HTTP-запроса.
* Stored (хранимый) XSS, когда вредоносный скрипт поступает из базы данных веб-сайта.
* DOM-based XSS, когда уязвимость существует в коде на стороне клиента, а не в коде на стороне сервера.

## Reflected cross-site scripting
Reflected XSS - это простейшая разновидность межсайтового скриптинга. Она возникает, когда приложение получает данные в HTTP-запросе и включает эти данные в немедленный ответ небезопасным способом.

Вот простой пример отраженной уязвимости XSS:
> https://insecure-website.com/status?message=All+is+well.
> <p>Status: All is well.</p>

Приложение не выполняет никакой другой обработки данных, поэтому злоумышленник может легко создать подобную атаку:
> https://insecure-website.com/status?message=<script>/*+Bad+stuff+here...+*/</script>
> <p>Status: <script>/* Bad stuff here... */</script></p>

Если пользователь посещает URL-адрес, созданный злоумышленником, то сценарий злоумышленника выполняется в браузере пользователя в контексте сеанса этого пользователя с приложением. В этот момент скрипт может выполнять любые действия и извлекать любые данные, к которым у пользователя есть доступ.

**![Reflected cross-site scripting]()**
## Stored cross-site scripting
Stored XSS (также известный как persistend или XSS второго порядка) возникает, когда приложение получает данные из ненадежного источника и включает эти данные в свои последующие HTTP-ответы небезопасным способом.

Данные, о которых идет речь, могут быть отправлены в приложение с помощью HTTP-запросов; например, комментарии к сообщению в блоге, псевдонимы пользователей в чате или контактные данные в заказе клиента. В других случаях данные могут поступать из других ненадежных источников; например, приложение веб-почты, отображающее сообщения, полученные по протоколу SMTP, маркетинговое приложение, отображающее сообщения в социальных сетях, или приложение для мониторинга сети, отображающее пакетные данные из сетевого трафика.

Вот простой пример уязвимости Stored XSS. Приложение для доски объявлений позволяет пользователям отправлять сообщения, которые отображаются другим пользователям:
> <p>Hello, this is my message!</p>

Приложение не выполняет никакой другой обработки данных, поэтому злоумышленник может легко отправить сообщение, которое атакует других пользователей:
> <p><script>/* Bad stuff here... */</script></p>

**![Stored cross-site scripting]()**
## DOM-based cross-site scripting
XSS на основе DOM (также известный как DOM XSS) возникает, когда приложение содержит некоторый JavaScript на стороне клиента, который обрабатывает данные из ненадежного источника небезопасным способом, обычно путем записи данных обратно в DOM.

В следующем примере приложение использует некоторый JavaScript для считывания значения из поля ввода и записи этого значения в элемент в HTML:
> var search = document.getElementById('search').value;
> var results = document.getElementById('results');
> results.innerHTML = 'You searched for: ' + search;

Если злоумышленник может контролировать значение поля ввода, он может легко создать вредоносное значение, которое приведет к выполнению их собственного сценария:
> You searched for: <img src=1 onerror='/* Bad stuff here... */'>

В типичном случае поле ввода будет заполнено из части HTTP-запроса, такой как параметр строки запроса URL, позволяющий злоумышленнику осуществить атаку с использованием вредоносного URL-адреса таким же образом, как и отраженный XSS.

**![DOM-based cross-site scripting]()**
# Для чего можно использовать XSS?
Злоумышленник, использующий уязвимость межсайтового скриптинга, как правило, может:

* Выдавать себя за пользователя-жертву или маскироваться под него.
* Выполнять любые действия, которые может выполнить пользователь.
* Считывать любые данные, к которым пользователь может получить доступ.
* Записывать учетные данные пользователя для входа.
* Выполнять виртуальную порчу веб-сайта.
* Внедрять троянские функции на веб-сайт.

## Влияние уязвимостей XSS
Фактическое воздействие атаки XSS обычно зависит от характера приложения, его функциональности и данных, а также статуса скомпрометированного пользователя. Например:

* В приложении для брошюр, где все пользователи анонимны, а вся информация общедоступна, влияние часто будет минимальным.
* В приложении, содержащем конфиденциальные данные, такие как банковские транзакции, электронные письма или медицинские записи, воздействие обычно будет серьезным.
* Если скомпрометированный пользователь имеет повышенные привилегии в приложении, то воздействие, как правило, будет критическим, позволяя злоумышленнику получить полный контроль над уязвимым приложением и поставить под угрозу всех пользователей и их данные.

**![Exploiting cross-site scripting vulnerabilities]()**
## Как найти и проверить уязвимости XSS
Подавляющее большинство уязвимостей XSS можно быстро и надежно обнаружить с помощью сканера веб-уязвимостей Burp Suite.

Ручное тестирование на наличие отраженных и сохраненных XSS обычно включает отправку некоторых простых уникальных входных данных (таких как короткая буквенно-цифровая строка) в каждую точку входа в приложении, определение каждого местоположения, в котором отправленные входные данные возвращаются в ответах HTTP, и тестирование каждого местоположения по отдельности, чтобы определить, можно ли использовать соответствующие входные данные для выполнения произвольного JavaScript. Таким образом, вы можете определить контекст, в котором происходит XSS, и выбрать подходящую полезную нагрузку для его использования.

Ручное тестирование XSS на основе DOM, возникающее из параметров URL, включает аналогичный процесс: размещение в параметре некоторого простого уникального ввода, использование инструментов разработчика браузера для поиска этого ввода в DOM и тестирование каждого местоположения, чтобы определить, пригодно ли оно для использования. Однако другие типы DOM XSS сложнее обнаружить. Чтобы найти уязвимости на основе DOM во входных данных, не основанных на URL (например, document.cookie), или приемниках, не основанных на HTML (например, setTimeout), нет замены просмотру кода JavaScript, что может занять чрезвычайно много времени. Сканер веб-уязвимостей Burp Suite сочетает в себе статический и динамический анализ JavaScript для надежной автоматизации обнаружения уязвимостей на основе DOM.

**![Cross-site scripting contexts]()**
## Content security policy
Политика безопасности контента (CSP) - это механизм браузера, который направлен на смягчение воздействия межсайтовых сценариев и некоторых других уязвимостей. Если приложение, использующее CSP, содержит поведение, подобное XSS, то CSP может препятствовать или предотвращать использование уязвимости. Часто CSP можно обойти, чтобы использовать основную уязвимость.

**![Content security policy]()**
## Инъекция висячей разметки
Внедрение висячей разметки - это метод, который может быть использован для сбора данных между доменами в ситуациях, когда полное использование межсайтового скриптинга невозможно из-за фильтров ввода или других средств защиты. Его часто можно использовать для сбора конфиденциальной информации, которая видна другим пользователям, включая токены CSRF, которые могут использоваться для выполнения несанкционированных действий от имени пользователя.

**![Dangling markup injection]()**
## Как предотвратить атаки XSS
Предотвращение межсайтовых сценариев в некоторых случаях является тривиальным, но может быть намного сложнее в зависимости от сложности приложения и способов обработки данных, управляемых пользователем.

В целом, эффективное предотвращение уязвимостей XSS, вероятно, потребует сочетания следующих мер:
* **Фильтруйте входные данные**. В момент получения пользовательского ввода отфильтруйте как можно строже, основываясь на ожидаемом или действительном вводе.
* **Кодируйте выходные данные**. В точке, где данные, управляемые пользователем, выводятся в ответах HTTP, кодируйте вывод, чтобы предотвратить его интерпретацию как активного содержимого. В зависимости от контекста вывода для этого может потребоваться применение комбинаций кодировки HTML, URL, JavaScript и CSS.
* **Используйте соответствующие заголовки ответов**. Чтобы предотвратить XSS в HTTP-ответах, которые не должны содержать HTML или JavaScript, вы можете использовать заголовки Content-Type и X-Content-Type-Options, чтобы убедиться, что браузеры интерпретируют ответы так, как вы ожидаете.
* **Content security policy (CSP)**. В качестве последней линии защиты вы можете использовать Политику безопасности содержимого (CSP), чтобы уменьшить серьезность любых уязвимостей XSS, которые все еще встречаются.

**![How to prevent XSS]()**
**![Find XSS vulnerabilities using Burp Suite's web vulnerability scanner]()**
## Основные вопросы об XSS
**Насколько распространены уязвимости XSS?** Уязвимости XSS очень распространены, и XSS, вероятно, является наиболее часто встречающейся уязвимостью веб-безопасности.
**Насколько распространены атаки XSS?** Трудно получить достоверные данные о реальных XSS-атаках, но, вероятно, они используются реже, чем другие уязвимости.
**В чем разница между XSS и CSRF?** XSS предполагает, что веб-сайт возвращает вредоносный JavaScript, в то время как CSRF предполагает побуждение пользователя-жертвы к выполнению действий, которые они не намерены выполнять.
**В чем разница между XSS и SQL-инъекцией?** XSS - это уязвимость на стороне клиента, предназначенная для других пользователей приложения, в то время как SQL инъекция - это уязвимость на стороне сервера, предназначенная для базы данных приложения.
**Как мне предотвратить XSS в PHP?** Отфильтруйте входные данные с помощью белого списка разрешенных символов и используйте подсказки типа или приведение типов. Экранируйте свои выходные данные с помощью htmlentities и ENT_QUOTES для контекстов HTML или экранирования юникода JavaScript для контекстов JavaScript.
**Как мне предотвратить XSS в Java?** Отфильтруйте входные данные с помощью белого списка разрешенных символов и используйте библиотеку, такую как Google Guava, для HTML-кодирования выходных данных для контекстов HTML или используйте экранирование Юникода JavaScript для контекстов JavaScript.
