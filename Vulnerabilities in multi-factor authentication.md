# Уязвимости в многофакторной аутентификации
Многие веб-сайты полагаются исключительно на однофакторную аутентификацию с использованием пароля для аутентификации пользователей. Однако некоторые требуют, чтобы пользователи подтверждали свою личность с помощью нескольких факторов аутентификации.

Проверка биометрических факторов непрактична для большинства веб-сайтов. Однако все чаще встречается как обязательная, так и необязательная двухфакторная аутентификация (2FA), основанная на том, **что вы знаете** и **что у вас есть**. Обычно для этого пользователям требуется ввести как традиционный пароль, так и временный проверочный код с находящегося в их распоряжении внешнего физического устройства.

Хотя иногда злоумышленник может получить один фактор, основанный на знаниях, такой как пароль, возможность одновременного получения другого фактора из внешнего источника значительно менее вероятна. По этой причине двухфакторная аутентификация явно более безопасна, чем однофакторная аутентификация. Однако, как и любая мера безопасности, она всегда так же безопасна, как и ее реализация. Плохо реализованную двухфакторную аутентификацию можно обойти или даже полностью обойти, так же как и однофакторную аутентификацию.

Также стоит отметить, что все преимущества многофакторной аутентификации достигаются только путем проверки нескольких **различных** факторов. Проверка одного и того же фактора двумя разными способами не является истинной двухфакторной аутентификацией. Одним из таких примеров является 2FA на основе электронной почты. Хотя пользователь должен предоставить пароль и проверочный код, доступ к коду зависит только от того, знают ли они учетные данные для входа в свою учетную запись электронной почты. Поэтому фактор аутентификации знаний просто проверяется дважды.
## Токены двухфакторной аутентификации
Проверочные коды обычно считываются пользователем с какого-либо физического устройства. Многие веб-сайты с высоким уровнем безопасности теперь предоставляют пользователям специальное устройство для этой цели, такое как токен RSA или устройство с клавиатурой, которое вы можете использовать для доступа к своему онлайн-банку или рабочему ноутбуку. В дополнение к тому, что эти специализированные устройства специально созданы для обеспечения безопасности, они также имеют преимущество в том, что генерируют проверочный код напрямую. Веб-сайты также часто используют специальное мобильное приложение, такое как Google Authenticator, по той же причине.

С другой стороны, некоторые веб-сайты отправляют проверочные коды на мобильный телефон пользователя в виде текстового сообщения. Хотя технически это все еще проверка фактора **"что-то  что у вас есть"**, он открыт для злоупотреблений. Во-первых, код передается по SMS, а не генерируется самим устройством. Это создает потенциальную возможность перехвата кода. Существует также риск замены SIM-карты, в результате чего злоумышленник обманным путем получает SIM-карту с номером телефона жертвы. Затем злоумышленник получит все SMS-сообщения, отправленные жертве, включая то, которое содержит их проверочный код.
## Обход двухфакторной аутентификации
Иногда реализация двухфакторной аутентификации несовершенна до такой степени, что ее можно полностью обойти.

Если пользователю сначала предлагается ввести пароль, а затем предлагается ввести проверочный код на отдельной странице, пользователь фактически находится в состоянии "logged in" до того, как он ввел проверочный код. В этом случае стоит проверить, можете ли вы сразу перейти на страницы "только для входа" после завершения первого шага аутентификации. Иногда вы обнаружите, что веб-сайт на самом деле не проверяет, выполнили ли вы второй шаг перед загрузкой страницы.
## Ошибочная логика двухфакторной проверки
Иногда ошибочная логика в двухфакторной аутентификации означает, что после того, как пользователь завершил начальный шаг входа в систему, веб-сайт не проверяет, что тот же пользователь выполняет второй шаг.

Например, пользователь входит в систему со своими обычными учетными данными на первом шаге следующим образом:
```
POST /login-steps/first HTTP/1.1
Host: vulnerable-website.com
...
username=carlos&password=qwerty
```
Затем им присваивается файл cookie, относящийся к их учетной записи, прежде чем перейти ко второму этапу процесса входа в систему:
```
HTTP/1.1 200 OK
Set-Cookie: account=carlos

GET /login-steps/second HTTP/1.1
Cookie: account=carlos
```
При отправке кода подтверждения запрос использует этот файл cookie, чтобы определить, к какой учетной записи пользователь пытается получить доступ:
```
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=carlos
...
verification-code=123456
```
В этом случае злоумышленник может войти в систему, используя свои собственные учетные данные, но затем изменить значение файла cookie учетной записи на любое произвольное имя пользователя при отправке кода подтверждения.
```
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=victim-user
...
verification-code=123456
```
Это чрезвычайно опасно, если злоумышленник затем сможет принудительно ввести проверочный код, поскольку это позволит им входить в учетные записи произвольных пользователей, полностью основываясь на их имени пользователя. Им даже не нужно было бы знать пароль пользователя.
## Брутфорс 2FA проверочных кодов
Как и в случае с паролями, веб-сайтам необходимо предпринять шаги для предотвращения грубого использования кода подтверждения 2FA. Это особенно важно, потому что код часто представляет собой простое 4- или 6-значное число. Без адекватной защиты от грубой силы взломать такой код тривиально.

Некоторые веб-сайты пытаются предотвратить это, автоматически выводя пользователя из системы, если он вводит определенное количество неверных проверочных кодов. На практике это неэффективно, потому что продвинутый злоумышленник может даже автоматизировать этот многоступенчатый процесс, создав макросы для Burp Intruder. Для этой цели также можно использовать расширение Turbo Intruder.
