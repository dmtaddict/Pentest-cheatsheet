# Аутентификационные уязвимости
По крайней мере, концептуально уязвимости аутентификации являются одними из самых простых проблем для понимания. Однако они могут быть одними из наиболее важных из-за очевидной взаимосвязи между аутентификацией и безопасностью. Помимо потенциального предоставления злоумышленникам прямого доступа к конфиденциальным данным и функциям, они также предоставляют дополнительную поверхность атаки для дальнейших эксплойтов. По этой причине изучение того, как выявлять и использовать уязвимости аутентификации, включая способы обхода распространенных мер защиты, является фундаментальным навыком.

В этом разделе мы рассмотрим некоторые из наиболее распространенных механизмов аутентификации, используемых веб-сайтами, и обсудим потенциальные уязвимости в них. Мы выделим как собственные уязвимости в различных механизмах аутентификации, так и некоторые типичные уязвимости, которые возникают из-за их неправильной реализации. Наконец, мы дадим некоторые основные рекомендации о том, как вы можете обеспечить, чтобы ваши собственные механизмы аутентификации были максимально надежными.
![](https://portswigger.net/web-security/images/password-reset-poisoning.svg)

## Что такое аутентификация
Аутентификация-это процесс проверки личности данного пользователя или клиента. Другими словами, она включает в себя проверку того, что они действительно те, за кого себя выдают. По крайней мере частично веб-сайты доступны всем, кто подключен к Интернету по дизайну. Поэтому надежные механизмы аутентификации являются неотъемлемым аспектом эффективной веб-безопасности.

Существует три фактора аутентификации, на которые можно разделить различные типы аутентификации:
* Что-то, что вы **знаете**, например, пароль или ответ на секретный вопрос. Их иногда называют "факторами знаний".
* Что-то, что у вас **есть**, то есть физический объект, такой как мобильный телефон или маркер безопасности. Их иногда называют "факторами владения".
* Что-то, чем вы **являетесь или чем занимаетесь**, например, ваши биометрические данные или модели поведения. Их иногда называют "факторами неотъемлимости".
Механизмы аутентификации полагаются на целый ряд технологий для проверки одного или нескольких из этих факторов.

## Какая разница между аутентификацией и авторизацией
*Аутентификация*-это процесс проверки того, что пользователь действительно **является тем, за кого себя выдает**, в то время как *авторизация* предполагает проверку того, **разрешено ли пользователю что-либо делать**.

В контексте веб-сайта или веб-приложения аутентификация определяет, действительно ли тот, кто пытается получить доступ к сайту с именем пользователя *Carlos123*, является тем же человеком, который создал учетную запись.

После аутентификации *Carlos123* его разрешения определяют, имеет ли он право, например, получать доступ к личной информации о других пользователях или выполнять такие действия, как удаление учетной записи другого пользователя.

## Как возникают уязвимости аутентификации
Вообще говоря, большинство уязвимостей в механизмах аутентификации возникают одним из двух способов:

* Механизмы аутентификации слабы, потому что они не в состоянии должным образом защитить от атак грубой силы.
* Логические недостатки или плохое кодирование в реализации позволяют злоумышленнику полностью обойти механизмы аутентификации. Это иногда называют "сломанной аутентификацией".

Во многих областях веб-разработки логические ошибки просто приведут к неожиданному поведению веб-сайта, что может и не быть проблемой безопасности. Однако, поскольку аутентификация настолько важна для безопасности, вероятность того, что ошибочная логика аутентификации подвергнет веб-сайт проблемам безопасности, явно повышена.
## Какое влияние имеют аутентификационные уязвимости
Влияние уязвимостей аутентификации может быть очень серьезным. Как только злоумышленник либо обойдет аутентификацию, либо грубо проникнет в учетную запись другого пользователя, он получит доступ ко всем данным и функциям, которыми обладает скомпрометированная учетная запись. Если они смогут скомпрометировать учетную запись с высокими привилегиями, такую как системный администратор, они смогут получить полный контроль над всем приложением и потенциально получить доступ к внутренней инфраструктуре.

Даже компрометация учетной записи с низким уровнем привилегий может по-прежнему предоставлять злоумышленнику доступ к данным, которые в противном случае у них не должно было быть, таким как коммерческая конфиденциальная деловая информация. Даже если учетная запись не имеет доступа к каким-либо конфиденциальным данным, она все равно может позволить злоумышленнику получить доступ к дополнительным страницам, которые обеспечивают дополнительную поверхность атаки. Часто некоторые атаки высокой степени серьезности невозможны с общедоступных страниц, но они могут быть возможны с внутренней страницы.
## Уязвимости в механизмах аутентификации
Система аутентификации веб-сайта обычно состоит из нескольких различных механизмов, в которых могут возникать уязвимости. Некоторые уязвимости широко применимы во всех этих контекстах, в то время как другие более специфичны для предоставляемых функций.

Мы более внимательно рассмотрим некоторые из наиболее распространенных уязвимостей в следующих областях:
* Уязвимости входа на основе паролей
* Уязвимости многофакторной аутентификации
* Уязвимости других механизмов аутентификации
### Атака грубой силой
Атака методом грубой силы-это когда злоумышленник использует систему проб и ошибок в попытке угадать действительные учетные данные пользователя. Эти атаки обычно автоматизируются с использованием словарей с именами пользователей и паролями. Автоматизация этого процесса, особенно с использованием специальных инструментов, потенциально позволяет злоумышленнику совершать огромное количество попыток входа в систему с высокой скоростью.

*Brute-force* - это не всегда просто случай совершенно случайных догадок об именах пользователей и паролях. Используя также базовую логику или общедоступные знания, злоумышленники могут точно настроить атаки методом грубой силы, чтобы сделать гораздо более обоснованные предположения. Это значительно повышает эффективность таких атак. Веб-сайты, которые полагаются на логин на основе пароля в качестве единственного метода аутентификации пользователей, могут быть очень уязвимыми, если они не реализуют достаточную защиту от грубой силы.
#### *Brute-force* имен пользователей
Имена пользователей особенно легко угадать, если они соответствуют узнаваемому шаблону, например адресу электронной почты. Например, очень часто можно увидеть бизнес-логины в формате *firstname.lastname@somecompany.com*. Однако, даже если нет очевидной закономерности, иногда даже учетные записи с высокими привилегиями создаются с использованием предсказуемых имен пользователей, таких как *Admin* или *Administrator*.

Во время аудита проверьте, раскрывает ли веб-сайт имена потенциальных пользователей публично. Например, можете ли вы получить доступ к профилям пользователей без входа в систему? Даже если фактическое содержимое профилей скрыто, имя, используемое в профиле, иногда совпадает с именем пользователя для входа. Вам также следует проверить HTTP-ответы, чтобы узнать, указаны ли какие-либо адреса электронной почты. Иногда ответы содержат адреса электронной почты пользователей с высокими привилегиями, таких как администраторы и ИТ-служба поддержки.
#### *Brute-force* паролей
Пароли также могут быть забручены, причем сложность зависит от надежности пароля. Многие веб-сайты используют ту или иную форму политики паролей, которая вынуждает пользователей создавать пароли с высокой энтропией, которые, по крайней мере теоретически, сложнее взломать с помощью только грубой силы. Обычно политика включает в себя:
* Минимальное количество символов
* Смесь строчных и прописных букв
* По крайней мере, один специальный символ

Однако, хотя пароли с высокой энтропией трудно взломать только одним компьютером, мы можем использовать базовые знания о поведении человека, чтобы использовать уязвимости, которые пользователи невольно вводят в эту систему. Вместо того чтобы создавать надежный пароль со случайной комбинацией символов, пользователи часто берут пароль, который они могут запомнить, и пытаются подогнать его под политику паролей. Например, если *mypassword* не разрешен, пользователи могут попробовать что-то вроде *Mypassword1!* или вместо этого *Myp4$$w0rd*.

В тех случаях, когда политика требует, чтобы пользователи регулярно меняли свои пароли, пользователи также часто просто вносят незначительные, предсказуемые изменения в предпочитаемый пароль. Например, *Mypassword1!* становится *Mypassword1?* или *Mypassword2!*.

Это знание вероятных учетных данных и предсказуемых шаблонов означает, что атаки методом грубой силы часто могут быть гораздо более сложными и, следовательно, эффективными, чем простое повторение всех возможных комбинаций символов.
#### Перечисление имен пользователей
Перечисление имен пользователей-это когда злоумышленник может наблюдать за изменениями в поведении веб-сайта, чтобы определить, является ли данное имя пользователя действительным.

Перечисление имен пользователей обычно происходит либо на странице входа в систему, например, когда вы вводите действительное имя пользователя, но неверный пароль, либо в регистрационных формах, когда вы вводите имя пользователя, которое уже занято. Это значительно сокращает время и усилия, необходимые для принудительного входа в систему, поскольку злоумышленник может быстро сгенерировать короткий список допустимых имен пользователей.

При попытке принудительного взлома страницы входа в систему вам следует обратить особое внимание на любые различия в:
* **Статус коды**: Во время атаки методом грубой силы возвращаемый код состояния HTTP, скорее всего, будет одинаковым для подавляющего большинства предположений, потому что большинство из них будут неверными. Если предположение возвращает другой код статуса, это явный признак того, что имя пользователя было правильным. Для веб-сайтов рекомендуется всегда возвращать один и тот же код статуса независимо от результата, но эта практика не всегда соблюдается.
* **Сообщения об ошибках**: Иногда возвращаемое сообщение об ошибке отличается в зависимости от того, неверны ли имя пользователя и пароль или неверен только пароль. В обоих случаях веб-сайтам рекомендуется использовать одинаковые общие сообщения, но иногда возникают небольшие ошибки при вводе текста. Всего один символ не на своем месте делает два сообщения отличными друг от друга, даже в тех случаях, когда символ не виден на отображаемой странице.
* **Время отклика**: Если большинство запросов обрабатывались с одинаковым временем отклика, любые отклонения от этого предполагают, что за кулисами происходило что-то другое. 
 
Это еще один признак того, что угаданное имя пользователя может быть правильным. Например, веб-сайт может проверять правильность пароля только в том случае, если имя пользователя является действительным. Этот дополнительный шаг может привести к небольшому увеличению времени отклика. Это может быть незаметно, но злоумышленник может сделать эту задержку более очевидной, введя чрезмерно длинный пароль, обработка которого на веб-сайте занимает заметно больше времени.
### Неправильная защита от грубой силы
Весьма вероятно, что атака методом грубой силы будет включать множество неудачных попыток, прежде чем злоумышленник успешно взломает учетную запись. Логично, что защита методом грубой силы направлена на то, чтобы максимально упростить автоматизацию процесса и снизить скорость, с которой злоумышленник может пытаться войти в систему. Двумя наиболее распространенными способами предотвращения атак грубой силы являются:
* Блокировка учетной записи, к которой пытается получить доступ удаленный пользователь, если он предпринимает слишком много неудачных попыток входа в систему
* Блокировка IP-адреса удаленного пользователя, если он делает слишком много попыток входа в систему с высокой частотой

Оба подхода обеспечивают различную степень защиты, но ни один из них не является неуязвимым, особенно если он реализован с использованием ошибочной логики.

Например, иногда вы можете обнаружить, что ваш IP-адрес заблокирован, если вы не входите в систему слишком много раз. В некоторых реализациях счетчик количества неудачных попыток сбрасывается, если владелец IP успешно входит в систему. Это означает, что злоумышленнику просто придется входить в свою учетную запись каждые несколько попыток, чтобы предотвратить достижение этого предела.

В этом случае простого включения ваших собственных учетных данных для входа через регулярные промежутки времени в список слов достаточно, чтобы сделать эту защиту практически бесполезной.
#### Блокировка аккаунта
Одним из способов, с помощью которого веб-сайты пытаются предотвратить *brute-force*, является блокировка учетной записи при соблюдении определенных подозрительных критериев, обычно определенного количества неудачных попыток входа в систему. Как и в случае обычных ошибок входа, ответы сервера, указывающие на то, что учетная запись заблокирована, также могут помочь злоумышленнику перечислить имена пользователей.

Блокировка учетной записи обеспечивает определенную степень защиты от целенаправленного взлома конкретной учетной записи. Однако этот подход не позволяет адекватно предотвратить атаки методом грубой силы, при которых злоумышленник просто пытается получить доступ к любой случайной учетной записи, которую он может.

Например, для обхода такого рода защиты можно использовать следующий метод:
1. Составьте список имен пользователей-кандидатов, которые, скорее всего, будут действительными. Это может быть путем перечисления имен пользователей или просто на основе списка общих имен пользователей.
1. Выберите очень небольшой список паролей, которые, по вашему мнению, могут быть у хотя бы одного пользователя. Важно отметить, что количество выбранных вами паролей не должно превышать количество разрешенных попыток входа в систему. Например, если вы определили, что ограничение составляет 3 попытки, вам нужно выбрать максимум 3 варианта пароля.
1. Используя такой инструмент, как Burp Intruder, попробуйте каждый из выбранных паролей с каждым из имен пользователей-кандидатов. Таким образом, вы можете попытаться применить грубую силу к каждой учетной записи, не вызывая блокировку учетной записи. Вам нужен только один пользователь, чтобы использовать один из трех паролей для взлома учетной записи.

Блокировка учетной записи также не защищает от атак на ввод учетных данных. Это предполагает использование огромного словаря пар *username*:*password*, состоящего из подлинных учетных данных для входа, украденных при утечке данных. Ввод учетных данных основан на том факте, что многие люди повторно используют одно и то же имя пользователя и пароль на нескольких веб-сайтах, и, следовательно, есть вероятность, что некоторые из скомпрометированных учетных данных в словаре также действительны на целевом веб-сайте. Блокировка учетной записи не защищает от ввода учетных данных, поскольку каждое имя пользователя используется только один раз. Вброс учетных данных особенно опасен, поскольку иногда это может привести к тому, что злоумышленник скомпрометирует множество различных учетных записей с помощью одной автоматической атаки.
#### Ограничение скорости
Еще один способ, которым веб-сайты пытаются предотвратить атаки грубой силы, - это ограничение скорости пользователей. В этом случае слишком большое количество запросов на вход в систему за короткий промежуток времени приводит к блокировке вашего IP-адреса. Как правило, IP-адрес может быть разблокирован только одним из следующих способов:
* Автоматически по истечении определенного периода времени
* Вручную администратором
* Вручную пользователем после успешного заполнения *КАПЧИ*

Ограничение скорости доступа пользователей иногда предпочтительнее блокировки учетной записи из-за меньшей подверженности перечислению имен пользователей и атакам типа "dos". Однако это все еще не совсем безопасно. Как мы видели в примере из предыдущей лаборатории, существует несколько способов, которыми злоумышленник может манипулировать своим очевидным IP-адресом, чтобы обойти блокировку.

Поскольку ограничение основано на частоте HTTP-запросов, отправляемых с IP-адреса пользователя, иногда также возможно обойти эту защиту, если вы можете понять, как угадать несколько паролей с помощью одного запроса.
### Базовая аутентификация по протоколу HTTP
Хотя он довольно старый, его относительная простота и простота реализации означают, что иногда вы можете увидеть, как используется базовая аутентификация HTTP. При базовой аутентификации HTTP клиент получает маркер аутентификации с сервера, который создается путем объединения имени пользователя и пароля и кодирования его в Base64. Этот токен хранится и управляется браузером, который автоматически добавляет его в заголовок авторизации каждого последующего запроса следующим образом:
*Authorization: Basic base64(username:password)*
По ряду причин это, как правило, не считается безопасным методом аутентификации. Во-первых, это включает в себя повторную отправку учетных данных пользователя при каждом запросе. Если веб-сайт также не реализует *HSTS*, учетные данные пользователя могут быть захвачены в результате атаки *"человек посередине"*.

Кроме того, реализации базовой аутентификации HTTP часто не поддерживают защиту от грубой силы. Поскольку токен состоит исключительно из статических значений, это может сделать его уязвимым для принудительного использования.

Базовая аутентификация HTTP также особенно уязвима для эксплойтов, связанных с сеансами, в частности CSRF, от которых она сама по себе не обеспечивает защиты.

В некоторых случаях использование уязвимой базовой аутентификации HTTP может предоставить злоумышленнику доступ только к, казалось бы, неинтересной странице. Однако, в дополнение к предоставлению дополнительной поверхности для атаки, учетные данные, предоставленные таким образом, могут быть повторно использованы в других, более конфиденциальных контекстах.
### Уязвимости в многофакторной аутентификации
Многие веб-сайты полагаются исключительно на однофакторную аутентификацию с использованием пароля для аутентификации пользователей. Однако некоторые требуют, чтобы пользователи подтверждали свою личность с помощью нескольких факторов аутентификации.

Проверка биометрических факторов непрактична для большинства веб-сайтов. Однако все чаще встречается как обязательная, так и необязательная двухфакторная аутентификация (2FA), основанная на том, **что вы знаете** и **что у вас есть**. Обычно для этого пользователям требуется ввести как традиционный пароль, так и временный проверочный код с находящегося в их распоряжении внешнего физического устройства.

Хотя иногда злоумышленник может получить один фактор, основанный на знаниях, такой как пароль, возможность одновременного получения другого фактора из внешнего источника значительно менее вероятна. По этой причине двухфакторная аутентификация явно более безопасна, чем однофакторная аутентификация. Однако, как и любая мера безопасности, она всегда так же безопасна, как и ее реализация. Плохо реализованную двухфакторную аутентификацию можно обойти или даже полностью обойти, так же как и однофакторную аутентификацию.

Также стоит отметить, что все преимущества многофакторной аутентификации достигаются только путем проверки нескольких **различных** факторов. Проверка одного и того же фактора двумя разными способами не является истинной двухфакторной аутентификацией. Одним из таких примеров является 2FA на основе электронной почты. Хотя пользователь должен предоставить пароль и проверочный код, доступ к коду зависит только от того, знают ли они учетные данные для входа в свою учетную запись электронной почты. Поэтому фактор аутентификации знаний просто проверяется дважды.
#### Токены двухфакторной аутентификации
Проверочные коды обычно считываются пользователем с какого-либо физического устройства. Многие веб-сайты с высоким уровнем безопасности теперь предоставляют пользователям специальное устройство для этой цели, такое как токен RSA или устройство с клавиатурой, которое вы можете использовать для доступа к своему онлайн-банку или рабочему ноутбуку. В дополнение к тому, что эти специализированные устройства специально созданы для обеспечения безопасности, они также имеют преимущество в том, что генерируют проверочный код напрямую. Веб-сайты также часто используют специальное мобильное приложение, такое как Google Authenticator, по той же причине.

С другой стороны, некоторые веб-сайты отправляют проверочные коды на мобильный телефон пользователя в виде текстового сообщения. Хотя технически это все еще проверка фактора **"что-то  что у вас есть"**, он открыт для злоупотреблений. Во-первых, код передается по SMS, а не генерируется самим устройством. Это создает потенциальную возможность перехвата кода. Существует также риск замены SIM-карты, в результате чего злоумышленник обманным путем получает SIM-карту с номером телефона жертвы. Затем злоумышленник получит все SMS-сообщения, отправленные жертве, включая то, которое содержит их проверочный код.
#### Обход двухфакторной аутентификации
Иногда реализация двухфакторной аутентификации несовершенна до такой степени, что ее можно полностью обойти.

Если пользователю сначала предлагается ввести пароль, а затем предлагается ввести проверочный код на отдельной странице, пользователь фактически находится в состоянии "logged in" до того, как он ввел проверочный код. В этом случае стоит проверить, можете ли вы сразу перейти на страницы "только для входа" после завершения первого шага аутентификации. Иногда вы обнаружите, что веб-сайт на самом деле не проверяет, выполнили ли вы второй шаг перед загрузкой страницы.
#### Ошибочная логика двухфакторной проверки
Иногда ошибочная логика в двухфакторной аутентификации означает, что после того, как пользователь завершил начальный шаг входа в систему, веб-сайт не проверяет, что тот же пользователь выполняет второй шаг.

Например, пользователь входит в систему со своими обычными учетными данными на первом шаге следующим образом:
```
POST /login-steps/first HTTP/1.1
Host: vulnerable-website.com
...
username=carlos&password=qwerty
```
Затем им присваивается файл cookie, относящийся к их учетной записи, прежде чем перейти ко второму этапу процесса входа в систему:
```
HTTP/1.1 200 OK
Set-Cookie: account=carlos

GET /login-steps/second HTTP/1.1
Cookie: account=carlos
```
При отправке кода подтверждения запрос использует этот файл cookie, чтобы определить, к какой учетной записи пользователь пытается получить доступ:
```
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=carlos
...
verification-code=123456
```
В этом случае злоумышленник может войти в систему, используя свои собственные учетные данные, но затем изменить значение файла cookie учетной записи на любое произвольное имя пользователя при отправке кода подтверждения.
```
POST /login-steps/second HTTP/1.1
Host: vulnerable-website.com
Cookie: account=victim-user
...
verification-code=123456
```
Это чрезвычайно опасно, если злоумышленник затем сможет принудительно ввести проверочный код, поскольку это позволит им входить в учетные записи произвольных пользователей, полностью основываясь на их имени пользователя. Им даже не нужно было бы знать пароль пользователя.
#### Брутфорс 2FA проверочных кодов
Как и в случае с паролями, веб-сайтам необходимо предпринять шаги для предотвращения грубого использования кода подтверждения 2FA. Это особенно важно, потому что код часто представляет собой простое 4- или 6-значное число. Без адекватной защиты от грубой силы взломать такой код тривиально.

Некоторые веб-сайты пытаются предотвратить это, автоматически выводя пользователя из системы, если он вводит определенное количество неверных проверочных кодов. На практике это неэффективно, потому что продвинутый злоумышленник может даже автоматизировать этот многоступенчатый процесс, создав макросы для Burp Intruder. Для этой цели также можно использовать расширение Turbo Intruder.
### Уязвимости в других механизмах аутентификации
В дополнение к основным функциям входа в систему большинство веб-сайтов предоставляют дополнительные функции, позволяющие пользователям управлять своей учетной записью. Например, пользователи обычно могут изменить свой пароль или сбросить его, если они его забудут. Эти механизмы также могут создавать уязвимости, которыми может воспользоваться злоумышленник.

Веб-сайты обычно стараются избегать хорошо известных уязвимостей на своих страницах входа в систему. Но легко упустить из виду тот факт, что вам необходимо предпринять аналогичные шаги, чтобы гарантировать, что соответствующие функции будут столь же надежными. Это особенно важно в тех случаях, когда злоумышленник может создать свою собственную учетную запись и, следовательно, имеет легкий доступ к изучению этих дополнительных страниц.
#### Сохранение состояния входа пользователей в систему
Общей особенностью является возможность оставаться в системе даже после закрытия сеанса браузера. Обычно это простой флажок с надписью что-то вроде "Запомнить меня" или "Оставаться в системе".

Эта функция часто реализуется путем создания какого-либо токена "запомни меня", который затем сохраняется в постоянном файле cookie. Поскольку обладание этим файлом cookie эффективно позволяет вам обойти весь процесс входа в систему, лучше всего, чтобы этот файл cookie было непрактично угадывать. Однако некоторые веб-сайты генерируют этот файл cookie на основе предсказуемого объединения статических значений, таких как имя пользователя и метка времени. Некоторые даже используют пароль как часть файла cookie. Этот подход особенно опасен, если злоумышленник может создать свою собственную учетную запись, потому что он может изучить свой собственный файл cookie и потенциально определить, как он создается. Как только они разработают формулу, они могут попытаться взломать файлы cookie других пользователей, чтобы получить доступ к своим учетным записям.

Некоторые веб-сайты предполагают, что если файл cookie каким-либо образом зашифрован, его невозможно будет угадать, даже если он использует статические значения. Хотя это может быть правдой, если все сделано правильно, наивное "шифрование" файла cookie с использованием простой двусторонней кодировки, такой как Base64, не обеспечивает никакой защиты. Даже использование правильного шифрования с односторонней хэш-функцией не является полностью пуленепробиваемым. Если злоумышленник способен легко идентифицировать алгоритм хеширования, и соль не используется, он потенциально может принудительно удалить файл cookie, просто хешируя свои списки слов. Этот метод можно использовать для обхода ограничений на попытки входа в систему, если аналогичное ограничение не применяется к предположениям о файлах cookie.

Даже если злоумышленник не сможет создать свою собственную учетную запись, он все равно сможет воспользоваться этой уязвимостью. Используя обычные методы, такие как XSS, злоумышленник может украсть файл cookie другого пользователя "запомни меня" и вывести, как из этого создается файл cookie. Если веб-сайт был создан с использованием платформы с открытым исходным кодом, ключевые детали создания файлов cookie могут быть даже публично задокументированы.

В некоторых редких случаях может оказаться возможным получить фактический пароль пользователя в виде открытого текста из файла cookie, даже если он хэширован. Хэшированные версии хорошо известных списков паролей доступны в Интернете, поэтому, если пароль пользователя появляется в одном из этих списков, расшифровка хэша иногда может быть такой же тривиальной, как просто вставка хэша в поисковую систему. Это демонстрирует важность соли в эффективном шифровании.
#### Сброс паролей пользователей
На практике считается, что некоторые пользователи забудут свой пароль, поэтому обычно у них есть способ его сбросить. Поскольку обычная аутентификация на основе пароля, очевидно, невозможна в этом сценарии, веб-сайтам приходится полагаться на альтернативные методы, чтобы убедиться, что реальный пользователь сбрасывает свой собственный пароль. По этой причине функция сброса пароля по своей сути опасна и должна быть реализована безопасно.

Существует несколько различных способов, которыми обычно реализуется эта функция, с различной степенью уязвимости.
##### Отправка паролей по электронной почте
Само собой разумеется, что отправка пользователям их текущего пароля никогда не должна быть возможной, если веб-сайт в первую очередь надежно обрабатывает пароли. Вместо этого некоторые веб-сайты генерируют новый пароль и отправляют его пользователю по электронной почте.

Вообще говоря, следует избегать отправки постоянных паролей по небезопасным каналам. В этом случае безопасность зависит либо от сгенерированного пароля, срок действия которого истекает через очень короткий промежуток времени, либо от того, что пользователь немедленно снова меняет свой пароль. В противном случае этот подход очень восприимчив к атакам "человек посередине".

Электронная почта также, как правило, не считается безопасной, учитывая, что почтовые ящики являются постоянными и на самом деле не предназначены для безопасного хранения конфиденциальной информации. Многие пользователи также автоматически синхронизируют свой почтовый ящик между несколькими устройствами по небезопасным каналам.
##### Сброс паролей с помощью URL-адреса
Более надежный способ сброса паролей - отправить пользователям уникальный URL-адрес, который приведет их на страницу сброса пароля. Менее безопасные реализации этого метода используют URL-адрес с легко угадываемым параметром, чтобы определить, какая учетная запись сбрасывается, например:
> http://vulnerable-website.com/reset-password?user=victim-user

В этом примере злоумышленник может изменить параметр пользователя, чтобы ссылаться на любое имя пользователя, которое он идентифицировал. Затем они будут перенаправлены прямо на страницу, где они потенциально могут установить новый пароль для этого произвольного пользователя.

Лучшей реализацией этого процесса является создание маркера с высокой энтропией, который трудно угадать, и создание URL-адреса сброса на его основе. В лучшем случае этот URL-адрес не должен содержать никаких подсказок о том, какой пароль пользователя сбрасывается.
> http://vulnerable-website.com/reset-password?token=a0ba0d1cb3b63d13822572fcff1a241895d893f659164d4cc550b421ebdd48a8

Когда пользователь посещает этот URL-адрес, система должна проверить, существует ли этот токен на серверной части, и если да, то пароль какого пользователя он должен сбросить. Этот токен должен истечь через короткий промежуток времени и быть уничтожен сразу же после сброса пароля.

Однако некоторые веб-сайты также не могут повторно проверить маркер при отправке формы сброса. В этом случае злоумышленник может просто зайти в форму сброса из своей учетной записи, удалить токен и использовать эту страницу для сброса пароля произвольного пользователя.

Если URL-адрес в электронном письме для сброса генерируется динамически, он также может быть уязвим для **отравления сброса пароля**. В этом случае злоумышленник потенциально может украсть токен другого пользователя и с его помощью изменить свой пароль.
>[Отравление сброса пароля](Password%20reset%20poisoning.md)

##### Изменение паролей пользователей
Как правило, смена пароля включает в себя ввод текущего пароля, а затем нового пароля дважды. Эти страницы в основном основаны на том же процессе проверки соответствия имен пользователей и текущих паролей, что и обычная страница входа в систему. Следовательно, эти страницы могут быть уязвимы для тех же методов.

Функция смены пароля может быть особенно опасной, если она позволяет злоумышленнику получить к ней прямой доступ, не входя в систему как пользователь-жертва. Например, если имя пользователя указано в скрытом поле, злоумышленник может изменить это значение в запросе, предназначенном для произвольных пользователей. Это потенциально может быть использовано для перечисления имен пользователей и паролей методом грубой силы.
## Предотвращение атак на Ваши механизмы аутентификации
Мы продемонстрировали несколько способов, с помощью которых веб-сайты могут быть уязвимы из-за того, как они реализуют аутентификацию. Чтобы снизить риск подобных атак на ваши собственные веб-сайты, существует несколько общих принципов, которым вы всегда должны стараться следовать.
### Как защитить механизм аутентификации
В этом разделе мы поговорим о том, как вы можете предотвратить некоторые из рассмотренных нами уязвимостей в ваших механизмах аутентификации.

Аутентификация-это сложная тема, и, как мы уже продемонстрировали, к сожалению, слишком легко проникнуть в слабые места, имеющие недостатки. Описание всех возможных мер, которые вы можете предпринять для защиты своих собственных веб-сайтов, явно невозможно. Однако есть несколько общих принципов, которым вы всегда должны следовать.
#### Будьте осторожны со своими идентификаторами
Даже самые надежные механизмы аутентификации неэффективны, если вы невольно раскрываете злоумышленнику действительный набор учетных данных для входа. Само собой разумеется, что вы никогда не должны отправлять какие-либо регистрационные данные по незашифрованным соединениям. Хотя вы, возможно, внедрили HTTPS для своих запросов на вход, убедитесь, что вы применяете это, перенаправляя любые попытки HTTP - запросов также на HTTPS.

Вы также должны провести аудит своего веб-сайта, чтобы убедиться, что имя пользователя или адреса электронной почты не раскрываются ни в общедоступных профилях, ни, например, в ответах HTTP.
#### Не расчитывайте на пользовательскую осторожность
Строгие меры аутентификации часто требуют от ваших пользователей некоторых дополнительных усилий. Человеческая природа делает почти неизбежным, что некоторые пользователи найдут способы сэкономить эти усилия. Поэтому вам необходимо обеспечить безопасное поведение везде, где это возможно.

Наиболее очевидным примером является внедрение эффективной политики паролей. Некоторые из более традиционных политик нарушаются, потому что люди вводят в политику свои собственные предсказуемые пароли. Вместо этого может быть более эффективным реализовать какую-либо простую проверку паролей, которая позволяет пользователям экспериментировать с паролями и обеспечивает обратную связь об их надежности в режиме реального времени. Популярным примером является библиотека *JavaScript zxcvbn*, разработанная компанией *Dropbox*. Разрешая использовать только те пароли, которые высоко оценены средством проверки паролей, вы можете обеспечить более эффективное использование безопасных паролей, чем при использовании традиционных политик.
#### Запретите разведку имен пользователей
Злоумышленнику значительно проще взломать ваши механизмы аутентификации, если вы обнаружите, что пользователь существует в системе. Существуют даже определенные ситуации, когда в силу характера веб-сайта информация о том, что у конкретного человека есть учетная запись, сама по себе является конфиденциальной информацией.

Независимо от того, является ли попытка ввести имя пользователя допустимой, важно использовать идентичные общие сообщения об ошибках и убедиться, что они действительно идентичны. Вы всегда должны возвращать один и тот же код состояния HTTP с каждым запросом на вход и, наконец, сделать время отклика в разных сценариях как можно более неразличимым.
#### Внедрите надежную защиту от брутфорса
Учитывая, насколько простым может быть построение атаки методом грубой силы, жизненно важно убедиться, что вы предпринимаете шаги для предотвращения или, по крайней мере, ограничения любых попыток входа в систему методом грубой силы.

Одним из наиболее эффективных методов является внедрение строгого ограничения скорости работы пользователей на основе IP-адресов. Это должно включать меры по предотвращению того, чтобы злоумышленники манипулировали своим очевидным IP-адресом. В идеале вы должны требовать, чтобы пользователь выполнял тест на *КАПЧУ* при каждой попытке входа в систему после достижения определенного предела.

Имейте в виду, что это не гарантирует полного устранения угрозы брутфорса. Однако, делая процесс максимально утомительным и ручным, насколько это возможно, увеличивает вероятность того, что любой потенциальный злоумышленник сдастся и вместо этого отправится на поиски более мягкой цели.
#### Трижды проверьте свою логику верификации
Как показали наши лаборатории, легко внедриться в код, в котором есть простые логические ошибки, которые в случае аутентификации могут полностью скомпрометировать ваш веб-сайт и пользователей. Тщательный аудит любой логики проверки или подтверждения для устранения ошибок является абсолютным ключом к надежной аутентификации. Проверка, которую можно обойти, в конечном счете, не намного лучше, чем отсутствие проверки вообще.
#### Не забывайте о дополнительных функциях
Убедитесь, что вы не просто сосредотачиваетесь на центральных страницах входа и не упускаете из виду дополнительные функции, связанные с аутентификацией. Это особенно важно в тех случаях, когда злоумышленник может свободно зарегистрировать свою собственную учетную запись и изучить эту функциональность. Помните, что сброс или изменение пароля является таким же надежным средством атаки, как и основной механизм входа в систему, и, следовательно, должен быть столь же надежным.
#### Внедрите правильную многофакторную аутентификацию
Хотя многофакторная аутентификация может быть непрактичной для каждого веб-сайта, при правильном выполнении она намного безопаснее, чем только вход на основе пароля. Помните, что проверка нескольких экземпляров одного и того же фактора не является истинной многофакторной аутентификацией. Отправка проверочных кодов по электронной почте - это, по сути, просто более длительная форма однофакторной аутентификации.

*2FA* на основе SMS технически проверяет два фактора (то, что вы знаете, и то, что у вас есть). Однако возможность злоупотреблений, например, при обмене SIM-картами, означает, что эта система может быть ненадежной.

В идеале *2FA* следует реализовать с помощью специального устройства или приложения, которое напрямую генерирует проверочный код. Поскольку они специально созданы для обеспечения безопасности, они, как правило, более безопасны.

Наконец, как и в случае с основной логикой аутентификации, убедитесь, что логика в ваших проверках *2FA* является надежной, чтобы ее было нелегко обойти.
